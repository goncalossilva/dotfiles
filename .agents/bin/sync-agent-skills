#!/usr/bin/env bash
set -euo pipefail

# This script used to symlink `~/.agents/skills/<name>` into both
# `~/.codex/skills/<name>` and `~/.claude/skills/<name>` (cleaner + no copies).
#
# Codex currently ignores symlinked skill directories, so we switched to rsync
# copies until symlinks are supported: https://github.com/openai/codex/issues/8369
#
# Old approach (for later):
#   ln -sfn "$AGENTS_SKILLS_DIR/$skill_name" "$CODEX_SKILLS_DIR/$skill_name"
#   ln -sfn "$AGENTS_SKILLS_DIR/$skill_name" "$CLAUDE_SKILLS_DIR/$skill_name"

AGENTS_SKILLS_DIR="${HOME}/.agents/skills"
AGENTS_INSTRUCTIONS_FILE="${HOME}/.agents/AGENTS.md"
CODEX_SKILLS_DIR="${HOME}/.codex/skills"
CLAUDE_SKILLS_DIR="${HOME}/.claude/skills"
CODEX_INSTRUCTIONS_FILE="${HOME}/.codex/AGENTS.md"
CLAUDE_INSTRUCTIONS_FILE="${HOME}/.claude/CLAUDE.md"

DRY_RUN=0
YES=0
PRUNE=0

usage() {
  cat <<'EOF'
Sync ~/.agents/skills and ~/.agents/AGENTS.md into Codex + Claude (copies, not symlinks).

Usage:
  sync-agent-skills [--dry-run] [--yes] [--prune]

Options:
  --dry-run   Print planned changes only
  --yes       Apply without prompting
  --prune     Remove skills from agent folders that are not present in ~/.agents/skills

Notes:
  - Codex ignores symlinked skill directories, so this uses rsync copies.
  - ~/.codex/skills/.system is never touched.
  - ~/.agents/AGENTS.md is synced to ~/.codex/AGENTS.md and ~/.claude/CLAUDE.md.
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    --yes)
      YES=1
      shift
      ;;
    --prune)
      PRUNE=1
      shift
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      echo "error: unknown argument: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

if ! command -v rsync >/dev/null 2>&1; then
  echo "error: rsync is required" >&2
  exit 1
fi

mkdir -p "${AGENTS_SKILLS_DIR}" "${CODEX_SKILLS_DIR}" "${CLAUDE_SKILLS_DIR}"

skills=()
for skill_dir in "${AGENTS_SKILLS_DIR}"/*; do
  [[ -d "${skill_dir}" ]] || continue
  skill_name="$(basename "${skill_dir}")"
  [[ "${skill_name}" == .* ]] && continue
  skills+=("${skill_name}")
done

declare -a plan=()

plan_rsync() {
  local src_dir="$1"
  local dest_dir="$2"
  plan+=("mkdir:${dest_dir}")
  plan+=("rsync:${src_dir}:${dest_dir}")
}

plan_rsync_file() {
  local src_file="$1"
  local dest_file="$2"
  plan+=("mkdir:$(dirname "${dest_file}")")
  plan+=("rsync_file:${src_file}:${dest_file}")
}

plan_remove() {
  local path="$1"
  plan+=("rmrf:${path}")
}

for skill_name in "${skills[@]}"; do
  skill_dir="${AGENTS_SKILLS_DIR}/${skill_name}"
  for target_root in "${CODEX_SKILLS_DIR}" "${CLAUDE_SKILLS_DIR}"; do
    target="${target_root}/${skill_name}"

    if [[ -L "${target}" ]]; then
      plan_remove "${target}"
      plan_rsync "${skill_dir}" "${target}"
      continue
    fi

    if [[ -d "${target}" ]]; then
      plan_rsync "${skill_dir}" "${target}"
      continue
    fi

    if [[ -e "${target}" ]]; then
      echo "skip: ${target} exists and is not a directory/symlink" >&2
      continue
    fi

    plan_rsync "${skill_dir}" "${target}"
  done
done

if [[ -f "${AGENTS_INSTRUCTIONS_FILE}" ]]; then
  for target in "${CODEX_INSTRUCTIONS_FILE}" "${CLAUDE_INSTRUCTIONS_FILE}"; do
    if [[ -L "${target}" ]]; then
      plan_remove "${target}"
      plan_rsync_file "${AGENTS_INSTRUCTIONS_FILE}" "${target}"
      continue
    fi

    if [[ -f "${target}" ]]; then
      plan_rsync_file "${AGENTS_INSTRUCTIONS_FILE}" "${target}"
      continue
    fi

    if [[ -e "${target}" ]]; then
      echo "skip: ${target} exists and is not a file/symlink" >&2
      continue
    fi

    plan_rsync_file "${AGENTS_INSTRUCTIONS_FILE}" "${target}"
  done
else
  echo "warn: ${AGENTS_INSTRUCTIONS_FILE} not found; skipping instruction sync" >&2
fi

if [[ "${PRUNE}" -eq 1 ]]; then
  for target_root in "${CODEX_SKILLS_DIR}" "${CLAUDE_SKILLS_DIR}"; do
    for entry in "${target_root}"/*; do
      [[ -e "${entry}" ]] || continue
      base="$(basename "${entry}")"
      [[ "${base}" == ".system" ]] && continue

      keep=0
      for skill_name in "${skills[@]}"; do
        if [[ "${base}" == "${skill_name}" ]]; then
          keep=1
          break
        fi
      done

      if [[ "${keep}" -eq 0 ]]; then
        plan_remove "${entry}"
      fi
    done
  done
fi

echo "Planned changes:"
for op in "${plan[@]}"; do
  kind="${op%%:*}"
  rest="${op#*:}"
  case "${kind}" in
    mkdir)
      echo "  - ensure dir: ${rest}"
      ;;
    rsync)
      src="${rest%%:*}"
      dest="${rest#*:}"
      echo "  - sync: ${src} -> ${dest} (rsync --delete)"
      ;;
    rsync_file)
      src="${rest%%:*}"
      dest="${rest#*:}"
      echo "  - sync file: ${src} -> ${dest}"
      ;;
    rmrf)
      echo "  - remove: ${rest}"
      ;;
  esac
done

if [[ "${DRY_RUN}" -eq 1 ]]; then
  exit 0
fi

if [[ "${YES}" -ne 1 ]]; then
  if [[ ! -t 0 ]]; then
    echo "error: refusing to apply changes non-interactively without --yes" >&2
    exit 2
  fi

  read -r -p "Apply these changes? [y/N] " answer
  case "${answer}" in
    y | Y | yes | YES) ;;
    *) echo "aborted"; exit 0 ;;
  esac
fi

applied=0
for op in "${plan[@]}"; do
  kind="${op%%:*}"
  rest="${op#*:}"
  case "${kind}" in
    mkdir)
      mkdir -p "${rest}"
      ;;
    rmrf)
      rm -rf "${rest}"
      ;;
    rsync)
      src="${rest%%:*}"
      dest="${rest#*:}"
      mkdir -p "${dest}"
      rsync -a --delete "${src}/" "${dest}/"
      ;;
    rsync_file)
      src="${rest%%:*}"
      dest="${rest#*:}"
      mkdir -p "$(dirname "${dest}")"
      rsync -a "${src}" "${dest}"
      ;;
  esac
  applied=$((applied + 1))
done

echo "applied ${applied} operations"
